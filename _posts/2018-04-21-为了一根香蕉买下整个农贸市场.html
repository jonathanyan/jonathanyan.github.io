<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
</head>
<body>
<p>给比特币加上智能合同 之一 </p>

<p>前面有人提到，现在国内能给区块链写core的人都困在上一个风口大数据中。新一代程序员未必看得上core，原因是不出活，机会少。</p>

<p>如同中兴事件中的高端芯片，从设计到出活有漫长的周期，投入大，中间还看不到成果。写core的也是如此。现在流行agile，两三周汇报一次开发成果。用python, javacript写UI和原型都是分分钟的事，老板不间断地看到成果，皆大欢喜。写core的，埋头一两个月，除了口头解释，没有任何能够演示的东西，即使勉强做demo，那一长串二进制数，让看的人摸不着头脑。</p>

<p>C++是写core的首选利器，真正用得好的人少之又少，成为古典程序员的古董玩具。C++强大的表达能力，让一个事情有了多种表述，这让沟通成为问题。A和B都是高手，各写一套，去看对方的程序，彼此都头疼。</p>

<p>说到这一点，要赞扬中本聪和V神。他们都会写程序，很厚道的写法，能让人看懂。中本聪用C++做bitcoin，编程风格平实，不炫技。年轻一点的V神直接上了go语言，简明清晰。</p>

<p>可林子大了，啥鸟都有。如果去读以太坊的C++版本cpp-ethereum，看的人很容易头就大了。各种“高级”写法，层层设置理解障碍。一个函数在强大的visual studio里竟然只有引用，没有定义。定义当然有，就是让你grep不到。</p>

<p>为什么要去读以太坊的c++版本呢？因为那里面有智能合同的实现，有可能无缝地移到bitcoin的代码中。一个有智能合同的bitcoin，安全性和表述性兼备，为区块链的扩展提供了无限相像空间。这曾经是V神的理想，中本聪没同意。后来，量子链也走了这条路，以一种妥协的方式，两套系统都拉进来，中间架桥。</p>

<p>如果不架桥，直接无缝连接，该怎么做呢？要做5件事，
1 虚拟机
2 状态树
3 账户体系
4 合同与bitcoin交易的共处
5 状态树与梅尔克树的共处</p>

<p>今天先说虚拟机，这个是以太坊的精华部分。白皮书里讲得清楚，虽然虚拟机功能强大，其核心代码只有几百行。这个不难找，几百行很容易抓出来。真正的Trouble来了，这几百行没法用。</p>

<p>比如，以太坊用了SHA3做hash算法，这个bitcoin没有，SHA3要引入吧。SHA3在哪儿呢？有一个库，叫libcryptopp，它有。可这个库很大，大得跟bitcoin的源代码行数是一个体量，几万行代码。量子链就是这么做的，为了一根香蕉，买进了整个农贸市场。说好的几百行呢？</p>

<p>当然，有更优雅的做法，只剥出SHA3算法部分，cpp-ethereum已经做了这件事，代码一共两百行，能找到这段程序，并调通它，但这需要一些耐心和精力。</p>

<p>虚拟机核心不是孤立存在的，总要有数据类型定义吧，调用接口要包装吧。以太坊现有接口以transaction为中心。只用虚拟机的话，上面硬加的transaction就没必要了。改写。</p>

<p>好了，把这一套剥离，洗干净，重新定义接口，做出一个bitcoin可用的虚拟机。成功，能用了。</p>

<p>最后数一下引入代码量：三千行。</p>

</body>
</html>